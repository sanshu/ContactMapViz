"use strict";function ContactMap(t){d3.select(t).html('<div class="row px-3" style="width:100%">'+this.buttonsHTML+this.alertHTML+"</div>"+this.cmHTML+this.tooltipHTML),this.hideAlert(),this._parentId=t}function toggle(t){$("#"+t).fadeToggle()}ContactMap.prototype.buttonsHTML='<div class="col-6"><button type="button" class="btn btn-info btn-outline-primary btn-sm active mx-1"data-toggle="button" onclick="toggle(\'cmap1\')">First</button><button type="button" class="btn btn-warning btn-outline-warning btn-sm active mx-1"  data-toggle="button" onclick="toggle(\'cmap2\')">Second</button><button type="button" class="btn btn-danger btn-outline-danger btn-sm active mx-1"  data-toggle="button" onclick="toggle(\'cmapsum\')">Difference</button></div>',ContactMap.prototype.alertHTML='<div class="alert alert-light col-6" role="alert" id="alertbox">&nbsp;</div>',ContactMap.prototype.cmHTML='<div class="row"><div class="col-12"><div id="contactMaps"></div></div>',ContactMap.prototype.tooltipHTML='<div id="tooltip" class="hidden"><p><span id="value"></p></div></div>',ContactMap.prototype.clear=function(){this.hideAlert(),this._width=0,this.data=null,d3.select("#contactMaps").select("svg").remove(),d3.select("#contactMaps").select("*").remove()},ContactMap.prototype.alert=function(t){d3.select("#alertbox").html(t)},ContactMap.prototype.hideAlert=function(){d3.select("#alertbox").html("")},ContactMap.prototype._parse=function(t){var e=t.matrix;try{var a,n,r,o,c=d3.dsvFormat("\t"),i=0,s=[],l=1,d=c.parseRows(e,function(t,e){o=+t[1],r=+t[3],i=Math.max(i,r,o),a=+t[1],n=t[0].substring(0,1),l=1==+t[4]?1:-1,s[o]||(s[o]=[]);var c=s[o][r];return c=c?c+l:l,s[o][r]=c,{id:e++,res1:t[0],col:o,res2:t[2],row:r,structId:+t[4],value:1}});return{max:i,matrix:d,seq1:t.seq1,seq2:t.seq2,datasum:s}}catch(t){return this.alert("Wrong input format. Required format: [res1 gridX res2 gridY strustureId]"),null}},ContactMap.prototype.draw=function(t){if(this.clear(),null===t)return void this.alert("Input data is empty.");var e=parseInt(d3.select(this._parentId).style("padding-left")),a=parseInt(d3.select(this._parentId).style("padding-right"));this._width=parseInt(d3.select(this._parentId).style("width"))-e-a-15,this.data=this._parse(t),null!==this.data&&this._draw()},ContactMap.prototype._addSequences=function(t,e){if(this.data.seq1){var a=t.append("g").attr("class","g3").attr("id","sequences1").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size",1.2*e).selectAll(".seq").data(this.data.seq1,function(t){return t}).enter();a.append("text").attr("dx",function(t,a){return(a+.5)*e}).attr("dy",function(t){return 3*-e}).text(function(t,e){return t}),a.append("text").attr("dy",function(t,a){return(a+1)*e}).attr("dx",function(t){return 3*-e}).text(function(t,e){return t})}this.data.seq2&&(a=t.append("g").attr("class","g3").attr("id","sequences2").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size",1.2*e).selectAll(".seq").data(this.data.seq2,function(t){return t}).enter(),a.append("text").attr("dx",function(t,a){return(a+.5)*e}).attr("dy",function(t){return-e}).text(function(t){return t}),a.append("text").attr("dy",function(t,a){return(a+1)*e}).attr("dx",function(t){return-e}).text(function(t,e){return t}))},ContactMap.prototype._createCMap=function(t,e,a,n,r){var o=this,c=a.append("g").attr("class","g3").attr("id",e).selectAll(".cellg").data(t,function(t){return t.row+":"+t.col}).enter();c.append("rect").attr("x",function(t){return t.col*n}).attr("y",function(t){return t.row*n}).attr("class",function(t){return"cell cell-border cr"+(t.row-1)+" cc"+(t.col-1)}).attr("width",n).attr("height",n).style("opacity",.7).style("fill",r).on("mouseover",function(t){o._createTooltip(t,o)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}).on("click",function(t){o._contactClicked(t)}),c.insert("rect").attr("y",function(t){return t.col*n}).attr("x",function(t){return t.row*n}).attr("class",function(t){return"cell cell-border cr"+(t.row-1)+" cc"+(t.col-1)}).attr("width",n).attr("height",n).style("opacity",.7).style("fill",r).on("mouseover",function(t){o._createTooltip(t,o)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}).on("click",function(t){o._contactClicked(t)})},ContactMap.prototype._getTooltipText=function(t,e){var a="",n="",r=this.data1.filter(function(a){return a.row===t&&a.col===e||a.row===e&&a.col===t});r[0]&&(a="CM1["+r[0].res1+":"+r[0].res2+"]");var o=this.data2.filter(function(a){return a.row===t&&a.col===e||a.row===e&&a.col===t});return o[0]&&(n="CM2["+o[0].res1+":"+o[0].res2+"]"),a.length>0&&n.length>0?a+", "+n:0===a.length&&0===n.length?"Grid: ["+(t+1)+":"+(e+1)+"]":a+n},ContactMap.prototype._createTooltip=function(t,e){d3.select("#tooltip").style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-10+"px").select("#value").text(e._getTooltipText(t.row,t.col)),d3.select("#tooltip").classed("hidden",!1)},ContactMap.prototype._draw=function(){function t(){p=d3.event.transform,M.attr("transform",p),y.call(v.scale(d3.event.transform.rescaleX(g))),b.call(x.scale(d3.event.transform.rescaleY(m)))}function e(t){u.scaleTo(f,d3.select(this).property("value"))}this.data1=this.data.matrix.filter(function(t){return 1===t.structId&&t.value>0}),this.data2=this.data.matrix.filter(function(t){return 2===t.structId&&t.value>0});var a=[];this.data.datasum.forEach(function(t,e){t.forEach(function(t,n){0!==t&&a.push({row:e,col:n,value:t})})}),this.alert("There are "+a.length+" non-matching contacts.");var n=this._width||400,r=this.data.max,o=r,c={top:50,right:20,bottom:20,left:50},i=n-c.left-c.right,s=i/r,l=i,d=i,p=null,u=d3.zoom().scaleExtent([.75,5]).translateExtent([[-20,-20],[l+40,d+40]]).on("zoom",t),f=(d3.select("#contactMaps").append("input").datum({}).attr("type","range").attr("value",1).attr("min",u.scaleExtent()[0]).attr("max",u.scaleExtent()[1]).attr("step",(u.scaleExtent()[1]-u.scaleExtent()[0])/100).on("input",e),d3.select("#contactMaps").append("svg").attr("width",l+c.left+c.right).attr("height",l+c.top+c.bottom)),h=f.append("g").attr("transform","translate("+c.left+","+c.top+")"),g=d3.scaleLinear().domain([0,r]).range([0,l]),m=d3.scaleLinear().domain([0,o]).range([0,d]),v=d3.axisBottom(g).ticks((l+2)/(d+2)*10).tickSize(d).tickPadding(-8-d),x=d3.axisRight(m).ticks(10).tickSize(l).tickPadding(-l-18),y=h.append("g").attr("class","axis axis--x").call(v),b=h.append("g").attr("class","axis axis--y").call(x),M=h.append("g").attr("class","view");this._addSequences(M,s),this._createCMap(this.data1,"cmap1",M,s,function(t){return"#007bff"}),this._createCMap(this.data2,"cmap2",M,s,function(t){return"#ffc107"}),this._createCMap(a,"cmapsum",M,s,function(t){return t.value>0?"#D50000":"#28a745"}),p&&M.attr("transform",p),f.call(u).on("wheel.zoom",null).on("dblclick.zoom",null)},ContactMap.prototype._contactClicked=function(t){this._processContactClick(t)},ContactMap.prototype._processContactClick=function(t){},ContactMap.prototype.onContactClick=function(t){"function"==typeof t&&(this._processContactClick=t)};