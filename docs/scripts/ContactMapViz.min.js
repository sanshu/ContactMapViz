function ContactMap(t){d3.select(t).html('<div class="row px-3" id="cmControls" style="width:100%">'+this.buttonsHTML+this.alertHTML+"</div>"+this.cmHTML+this.tooltipHTML),this.hideAlert(),this._parentId=t,this.setVisualProps(this._defaultVisualProperties)}function toggle(t){$("#"+t).fadeToggle()}ContactMap.prototype._defaultVisualProperties={colors:{cmap1:"#007bff",cmapText1:"white",cmap2:"#ffc107",cmapText2:"black",positiveDiff:"dc3545",negativeDiff:"green",cmapTextDiff:"white"}},ContactMap.prototype.visualProperties={},ContactMap.prototype.setVisualProps=function(t){const e=Object.assign(this._defaultVisualProperties,t);console.log(e),this.visualProperties=e;const a=this.visualProperties.colors;function o(t,e,a){const o="color:"+a+";background-color:"+e+";border-color:"+e;d3.select("#"+t).attr("style",o)}o("cmap-btn-1",a.cmap1,a.cmapText1),o("cmap-btn-2",a.cmap2,a.cmapText2),o("cmap-btn-diff",a.positiveDiff,a.cmapTextDiff)},ContactMap.prototype.buttonsHTML='<div class="col-6"><button type="button" id="cmap-btn-1" class="btn btn-outline btn-sm active mx-1"data-toggle="button" onclick="toggle(\'cmap1\')">First</button><button type="button" id="cmap-btn-2" class="btn btn-sm active mx-1"  data-toggle="button" onclick="toggle(\'cmap2\')">Second</button><button type="button" id="cmap-btn-diff" class="btn btn-sm active mx-1"  data-toggle="button" onclick="toggle(\'cmapsum\')">Difference</button></div>',ContactMap.prototype.alertHTML='<div class="alert alert-light col-6" role="alert" id="alertbox">&nbsp;</div>',ContactMap.prototype.cmHTML='<div class="row"><div class="col-12"><div id="contactMaps"></div></div>',ContactMap.prototype.tooltipHTML='<div id="tooltip" class="hidden"><p><span id="value"></p></div></div>',ContactMap.prototype.ccellSize=1,ContactMap.prototype.clear=function(){this.hideAlert(),this._width=0,this.data=null,d3.select("#contactMaps").select("svg").remove(),d3.select("#contactMaps").select("*").remove()},ContactMap.prototype.alert=function(t){d3.select("#alertbox").html(t)},ContactMap.prototype.hideAlert=function(){d3.select("#alertbox").html("")},ContactMap.prototype._parse=function(t){var e=t.matrix;try{var a,o,r=d3.dsvFormat("\t"),c=0,n=[],i=1,s=r.parseRows(e,(function(t,e){o=+t[1],a=+t[3],c=Math.max(c,a,o),+t[1],t[0].substring(0,1),i=1==+t[4]?1:-1,n[o]||(n[o]=[]);var r=n[o][a];return r=r?r+i:i,n[o][a]=r,{id:e++,res1:t[0],col:o,res2:t[2],row:a,structId:+t[4],value:1}}));return{max:c,matrix:s,seq1:t.seq1,seq2:t.seq2,datasum:n}}catch(t){return console.error(t),this.alert("Wrong input format. Required format: [res1 gridX res2 gridY strustureId]"),null}},ContactMap.prototype.draw=function(t){if(this.clear(),console.log("CM Cleared.."),null!==t){var e=parseInt(d3.select(this._parentId).style("padding-left")),a=parseInt(d3.select(this._parentId).style("padding-right"));this._width=parseInt(d3.select(this._parentId).style("width"))-e-a-15,this.data=this._parse(t),null!==this.data&&this._draw()}else this.alert("Input data is empty.")},ContactMap.prototype._addSequences=function(t,e){if(this.data.seq1){var a=t.append("g").attr("class","g3").attr("id","sequences1").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size",1.2*e).selectAll(".seq").data(this.data.seq1,(function(t){return t})).enter();a.append("text").attr("dx",(function(t,a){return(a+.5)*e})).attr("dy",(function(t){return 3*-e})).text((function(t,e){return t})),a.append("text").attr("dy",(function(t,a){return(a+1)*e})).attr("dx",(function(t){return 3*-e})).text((function(t,e){return t}))}this.data.seq2&&((a=t.append("g").attr("class","g3").attr("id","sequences2").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size",1.2*e).selectAll(".seq").data(this.data.seq2,(function(t){return t})).enter()).append("text").attr("dx",(function(t,a){return(a+.5)*e})).attr("dy",(function(t){return-e})).text((function(t){return t})),a.append("text").attr("dy",(function(t,a){return(a+1)*e})).attr("dx",(function(t){return-e})).text((function(t,e){return t})))},ContactMap.prototype._createCMap=function(t,e,a,o,r){const c=this;var n=a.append("g").attr("class","g3").attr("id",e).selectAll(".cellg").data(t,(function(t){return t.row+":"+t.col})).enter();n.append("rect").attr("x",(function(t){return(t.col-1)*o})).attr("y",(function(t){return(t.row-1)*o})).attr("class",(function(t){return"cell cell-border cr"+(t.row-1)+" cc"+(t.col-1)})).attr("width",o).attr("height",o).style("opacity",.7).style("fill",r).on("mouseover",(function(t){c._createTooltip(t,c)})).on("mouseout",(function(){d3.select("#tooltip").classed("hidden",!0)})).on("click",(function(t){c._contactClicked(t)})),n.insert("rect").attr("y",(function(t){return(t.col-1)*o})).attr("x",(function(t){return(t.row-1)*o})).attr("class",(function(t){return"cell cell-border cr"+(t.row-1)+" cc"+(t.col-1)})).attr("width",o).attr("height",o).style("opacity",.7).style("fill",r).on("mouseover",(function(t){c._createTooltip(t,c)})).on("mouseout",(function(){d3.select("#tooltip").classed("hidden",!0)})).on("click",(function(t){c._contactClicked(t)}))},ContactMap.prototype.getResiduesAt=function(t,e){var a={},o=this.data1.filter(a=>a.row===t&&a.col===e||a.row===e&&a.col===t);o[0]&&(a.cm1={},a.cm1.res1=o[0].res1,a.cm1.res2=o[0].res2);var r=this.data2.filter(a=>a.row===t&&a.col===e||a.row===e&&a.col===t);return r[0]&&(a.cm2={},a.cm2.res1=r[0].res1,a.cm2.res2=r[0].res2),a},ContactMap.prototype._getTooltipText=function(t,e){var a="",o="",r=this.data1.filter(a=>a.row===t&&a.col===e||a.row===e&&a.col===t);r[0]&&(a="CM1["+r[0].res1+":"+r[0].res2+"]");var c=this.data2.filter(a=>a.row===t&&a.col===e||a.row===e&&a.col===t);return c[0]&&(o="CM2["+c[0].res1+":"+c[0].res2+"]"),a.length>0&&o.length>0?a+", "+o:0===a.length&&0===o.length?"Grid: ["+(t+1)+":"+(e+1)+"]":a+o},ContactMap.prototype._createTooltip=function(t,e){d3.select("#tooltip").style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-10+"px").select("#value").text(e._getTooltipText(t.row,t.col)),d3.select("#tooltip").classed("hidden",!1)},ContactMap.prototype._draw=function(){this.data1=this.data.matrix.filter(t=>1===t.structId&&t.value>0),this.data2=this.data.matrix.filter(t=>2===t.structId&&t.value>0);var t=[];this.data.datasum.forEach((function(e,a){e.forEach((function(e,o){0!==e&&t.push({row:a,col:o,value:e})}))})),this.alert(`There are ${t.length} non-matching contacts.`);var e=this._width||400,a=this.data.max,o=a,r=25,c=20,n=20,i=20,s=e-i-c,l=s/a,p=s,d=s,u=null;this.ccellSize=l;var h=d3.zoom().scaleExtent([1,5]).translateExtent([[-10,-12],[p+20,d+20]]).on("zoom",(function(){u=d3.event.transform,b.attr("transform",u),C.call(y.scale(d3.event.transform.rescaleX(g))),M.call(x.scale(d3.event.transform.rescaleY(v)))})),f=(d3.select("#contactMaps").append("input").datum({}).attr("type","range").attr("value",1).attr("min",h.scaleExtent()[0]).attr("max",h.scaleExtent()[1]).attr("step",(h.scaleExtent()[1]-h.scaleExtent()[0])/100).on("input",(function(t){h.scaleTo(f,d3.select(this).property("value"))})),d3.select("#contactMaps").append("svg").attr("width",p+i+c).attr("height",p+r+n)),m=f.append("g").attr("transform","translate("+i+","+r+")"),g=d3.scaleLinear().domain([0,a]).range([0,p]),v=d3.scaleLinear().domain([0,o]).range([0,d]),y=d3.axisBottom(g).ticks((p+2)/(d+2)*10).tickSize(d).tickPadding(-8-d),x=d3.axisRight(v).ticks(10).tickSize(p).tickPadding(-p-18),C=m.append("g").attr("class","axis axis--x").call(y),M=m.append("g").attr("class","axis axis--y").call(x),b=m.append("g").attr("class","view");this._addSequences(b,l);const w=this.visualProperties.colors;this._createCMap(this.data1,"cmap1",b,l,(function(t){return w.cmap1})),this._createCMap(this.data2,"cmap2",b,l,(function(t){return w.cmap2})),this._createCMap(t,"cmapsum",b,l,(function(t){return t.value>0?w.positiveDiff:w.negativeDiff}));b.append("g").attr("id","hlights");d3.select("#hlights").append("circle").attr("id","hlight1").attr("cx",0).attr("cy",0).attr("r",0),d3.select("#hlights").append("circle").attr("id","hlight2").attr("cx",0).attr("cy",0).attr("r",0),u&&b.attr("transform",u),f.call(h).on("wheel.zoom",null).on("dblclick.zoom",null)},ContactMap.prototype.highlightContact=function(t,e,a="yellow",o=3){const r=o*this.ccellSize,c=t?(t-.5)*this.ccellSize:0,n=e?(e-.5)*this.ccellSize:0;d3.select("#hlights").select("#hlight1").attr("cx",c).attr("cy",n),d3.select("#hlights").select("#hlight2").attr("cx",n).attr("cy",c),d3.select("#hlights").selectAll("circle").attr("r",0).attr("stroke",a).attr("stroke-opacity",1).attr("fill","none").attr("opacity",1).transition().duration(1e3).attr("r",r)},ContactMap.prototype.removeHighlight=function(){d3.select("#hlights").select("circle").attr("r",0).attr("opacity",0)},ContactMap.prototype._contactClicked=function(t){let e=this.getResiduesAt(t.row,t.col);t.residues=e,this._processContactClick(t)},ContactMap.prototype._processContactClick=function(t){console.log("clicked")},ContactMap.prototype.onContactClick=function(t){"function"==typeof t?this._processContactClick=t:console.error("Callback is not a function!")},ContactMap.prototype.toggleControls=function(t){t?d3.select("#cmControls").attr("hidden",null):d3.select("#cmControls").attr("hidden","")};