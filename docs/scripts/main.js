"use strict";function ContactMap(t){d3.select(t).html('<div class="row px-3" style="width:100%">'+this.buttonsHTML+this.alertHTML+"</div>"+this.cmHTML+this.tooltipHTML),this.hideAlert(),this._parentId=t}function toggle(t){$("#"+t).fadeToggle()}ContactMap.prototype.buttonsHTML='<div class="col-6"><button type="button" class="btn btn-outline-primary btn-sm active mx-1"data-toggle="button" onclick="toggle(\'cmap1\')">First</button><button type="button" class="btn btn-outline-warning btn-sm active mx-1"  data-toggle="button" onclick="toggle(\'cmap2\')">Second</button><button type="button" class="btn btn-outline-danger btn-sm active mx-1"  data-toggle="button" onclick="toggle(\'cmapsum\')">Difference</button></div>',ContactMap.prototype.alertHTML='<div class="alert alert-light col-6" role="alert" id="alertbox">&nbsp;</div>',ContactMap.prototype.cmHTML='<div class="row"><div class="col-12"><div id="contactMaps"></div></div>',ContactMap.prototype.tooltipHTML='<div id="tooltip" class="hidden"><p><span id="value"></p></div></div>',ContactMap.prototype.clear=function(){this.hideAlert(),this._width=0,this.data=null,d3.select("svg").remove(),d3.select("#contactMaps").select("*").remove()},ContactMap.prototype.alert=function(t){d3.select("#alertbox").html(t)},ContactMap.prototype.hideAlert=function(){d3.select("#alertbox").html("")},ContactMap.prototype.parse=function(t){try{var e,a,r=d3.dsvFormat("\t"),n=0,o=[],c=[],i=-1,s=r.parseRows(t,function(t,r){return n=Math.max(n,+t[1],+t[3],+t[6],+t[8]),e=+t[0].substring(1),a=t[0].substring(0,1),o[e]=a,e=+t[5].substring(1),a=t[5].substring(0,1),c[e]=a,{id:r++,structure1:{res1:t[0],col:+t[1],res2:t[2],row:+t[3],value:+t[4]},structure2:{res1:t[5],col:+t[6],res2:t[7],row:+t[8],value:+t[9]}}});for(i=0;i<=n;i++)o[i]||(o[i]="-"),c[i]||(c[i]="-");return{max:n,matrix:s,seq1:o,seq2:c}}catch(t){return this.alert("Wrong input format. "),null}},ContactMap.prototype.draw=function(t){if(this.clear(),0===t.trim().length)return void this.alert("Input data is empty.");var e=parseInt(d3.select(this._parentId).style("padding-left")),a=parseInt(d3.select(this._parentId).style("padding-right"));this._width=parseInt(d3.select(this._parentId).style("width"))-e-a-15,this.data=this.parse(t.trim()),null!==this.data&&this._draw()},ContactMap.prototype._addSequences=function(t,e){var a=t.append("g").attr("class","g3").attr("id","sequences1").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size",1.2*e).selectAll(".seq").data(this.data.seq1,function(t){return t}).enter();a.append("text").attr("dx",function(t,a){return(a+.5)*e}).attr("dy",function(t){return 3*-e}).text(function(t,e){return t}),a.append("text").attr("dy",function(t,a){return(a+1)*e}).attr("dx",function(t){return 3*-e}).text(function(t,e){return t}),a=t.append("g").attr("class","g3").attr("id","sequences2").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size",1.2*e).selectAll(".seq").data(this.data.seq2,function(t){return t}).enter(),a.append("text").attr("dx",function(t,a){return(a+.5)*e}).attr("dy",function(t){return-e}).text(function(t){return t}),a.append("text").attr("dy",function(t,a){return(a+1)*e}).attr("dx",function(t){return-e}).text(function(t,e){return t})},ContactMap.prototype._createCMap=function(t,e,a,r,n){var o=this,c=a.append("g").attr("class","g3").attr("id",e).selectAll(".cellg").data(t,function(t){return t.row+":"+t.col}).enter();c.append("rect").attr("x",function(t){return t.col*r}).attr("y",function(t){return t.row*r}).attr("class",function(t){return"cell cell-border cr"+(t.row-1)+" cc"+(t.col-1)}).attr("width",r).attr("height",r).style("opacity",.7).style("fill",n).on("mouseover",function(t){o._createTooltip(t,o)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}),c.insert("rect").attr("y",function(t){return t.col*r}).attr("x",function(t){return t.row*r}).attr("class",function(t){return"cell cell-border cr"+(t.row-1)+" cc"+(t.col-1)}).attr("width",r).attr("height",r).style("opacity",.7).style("fill",n).on("mouseover",function(t){o._createTooltip(t,o)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)})},ContactMap.prototype._getTooltipText=function(t,e){var a=this.data.seq1[t],r=this.data.seq1[e],n=this.data.seq2[t],o=this.data.seq2[e];return t+=1,e+=1,"CM1["+a+t+":"+r+e+"], CM2["+n+t+":"+o+e+"]"},ContactMap.prototype._createTooltip=function(t,e){d3.select("#tooltip").style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-10+"px").select("#value").text(e._getTooltipText(t.row,t.col)),d3.select("#tooltip").classed("hidden",!1)},ContactMap.prototype._draw=function(){function t(){f=d3.event.transform,C.attr("transform",f),M.call(y.scale(d3.event.transform.rescaleX(v))),w.call(b.scale(d3.event.transform.rescaleY(x)))}function e(t){h.scaleTo(m,d3.select(this).property("value"))}var a=this.data.matrix.filter(function(t){return t.structure1.value>0}).map(function(t){return{row:t.structure1.row,col:t.structure1.col,value:t.structure1.value,id:t.id}}),r=this.data.matrix.filter(function(t){return t.structure2.value>0}).map(function(t){return{row:t.structure2.row,col:t.structure2.col,value:t.structure2.value,id:t.id}}),n=this.data.matrix.filter(function(t){return t.structure1.value!==t.structure2.value}).map(function(t){return{row:t.structure2.row,col:t.structure2.col,value:t.structure2.value-t.structure1.value,id:t.id}});this.alert("There are "+n.length+" non-matching contacts.");var o=this._width||400,c=this.data.max,i=c,s={top:50,right:20,bottom:20,left:50},l=o-s.left-s.right,u=l/c,d=l,p=l,f=null,h=d3.zoom().scaleExtent([.75,5]).translateExtent([[-20,-20],[d+40,p+40]]).on("zoom",t),m=(d3.select("#contactMaps").append("input").datum({}).attr("type","range").attr("value",1).attr("min",h.scaleExtent()[0]).attr("max",h.scaleExtent()[1]).attr("step",(h.scaleExtent()[1]-h.scaleExtent()[0])/100).on("input",e),d3.select("#contactMaps").append("svg").attr("width",d+s.left+s.right).attr("height",d+s.top+s.bottom)),g=m.append("g").attr("transform","translate("+s.left+","+s.top+")"),v=d3.scaleLinear().domain([0,c]).range([0,d]),x=d3.scaleLinear().domain([0,i]).range([0,p]),y=d3.axisBottom(v).ticks((d+2)/(p+2)*10).tickSize(p).tickPadding(-8-p),b=d3.axisRight(x).ticks(10).tickSize(d).tickPadding(-d-18),M=g.append("g").attr("class","axis axis--x").call(y),w=g.append("g").attr("class","axis axis--y").call(b),C=g.append("g").attr("class","view");this._addSequences(C,u),this._createCMap(a,"cmap1",C,u,function(t){return"#007bff"}),this._createCMap(r,"cmap2",C,u,function(t){return"#ffc107"}),this._createCMap(n,"cmapsum",C,u,function(t){return t.value>0?"#D50000":"#28a745"}),f&&C.attr("transform",f),m.call(h).on("wheel.zoom",null).on("dblclick.zoom",null)};